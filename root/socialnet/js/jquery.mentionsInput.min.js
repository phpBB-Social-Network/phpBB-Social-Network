/*
 Mentions Input
 Version 1.0.2
 Written by: Kenneth Auchenberg (Podio)

 Using underscore.js

 License: MIT License - http://www.opensource.org/licenses/mit-license.php
*/
(function(d,c){var t,y,z,A,B,C,u,D,E;t=8;y=9;z=13;A=37;B=38;C=39;u=40;D=36;E=35;var J={triggerChar:"@",onDataRequest:d.noop,minChars:2,showAvatars:!0,elastic:!0,classes:{autoCompleteItemActive:"active"},templates:{wrapper:c.template('<div class="mentions-input-box"></div>'),autocompleteList:c.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:c.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:c.template('<img src="<%= avatar %>" />'),
autocompleteListItemIcon:c.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:c.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:c.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:c.template("<strong><span><%= value %></span></strong>")}},j={htmlEncode:function(b){return c.escape(b)},highlightTerm:function(b,c){return!c&&!c.length?b:b.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+c+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")},setCaratPosition:function(b,
c){if(b.createTextRange){var d=b.createTextRange();d.move("character",c);d.select()}else b.selectionStart?(b.focus(),b.setSelectionRange(c,c)):b.focus()},rtrim:function(b){return b.replace(/\s+$/,"")}},x=function(b){function h(){var a=r();c.each(f,function(c){var l=b.templates.mentionItemSyntax(c);a=a.replace(c.value,l)});var l=j.htmlEncode(a);c.each(f,function(a){var d=c.extend({},a,{value:j.htmlEncode(a.value)});a=b.templates.mentionItemSyntax(d);d=b.templates.mentionItemHighlight(d);l=l.replace(a,
d)});l=l.replace(/\n/g,"<br />");l=l.replace(/ {2}/g,"&nbsp; ");e.data("messageText",a);w.find("div").html(l)}function v(){m=[]}function p(a){var c=r(),d=RegExp("\\"+b.triggerChar+n,"gi");d.exec(c);var g=d.lastIndex,d=c.substr(0,d.lastIndex-n.length-1),c=c.substr(g,c.length),g=(d+a.value).length+1;f.push(a);v();n="";s();e.val(d+a.value+" "+c);h();e.focus();j.setCaratPosition(e[0],g)}function r(){return d.trim(e.val())}function x(){var a=d(this),a=F[a.attr("data-uid")];p(a);return!1}function K(){v()}
function L(){s()}function M(){h();var a=r();f=c.reject(f,function(c){return!c.value||-1==a.indexOf(c.value)});f=c.compact(f);var d=c.lastIndexOf(m,b.triggerChar);-1<d&&(n=m.slice(d+1).join(""),n=j.rtrim(n),c.defer(c.bind(N,this,n)))}function O(a){a.keyCode!==t&&(a=String.fromCharCode(a.which||a.keyCode),m.push(a))}function P(a){if(a.keyCode==A||a.keyCode==C||a.keyCode==D||a.keyCode==E)c.defer(v),-1<navigator.userAgent.indexOf("MSIE 9")&&c.defer(h);else if(a.keyCode==t)m=m.slice(0,-1+m.length);else{if(!g.is(":visible"))return!0;
switch(a.keyCode){case B:case u:var b=null,b=a.keyCode==u?k&&k.length?k.next():g.find("li").first():d(k).prev();b.length&&G(b);return!1;case z:case y:if(k&&k.length)return k.trigger("mousedown"),!1}return!0}}function s(){k=null;g.empty().hide()}function G(a){a.addClass(b.classes.autoCompleteItemActive);a.siblings().removeClass(b.classes.autoCompleteItemActive);k=a}function N(a){a&&a.length&&a.length>=b.minChars?b.onDataRequest.call(this,"search",a,function(e){g.show();var k=c.pluck(f,"value");e=c.reject(e,
function(a){return c.include(k,a.name)});if(e.length){g.empty();var h=d("<ul>").appendTo(g).hide();c.each(e,function(e,g){var f=c.uniqueId("mention_");F[f]=c.extend({},e,{value:e.name});f=d(b.templates.autocompleteListItem({id:j.htmlEncode(e.id),display:j.htmlEncode(e.name),type:j.htmlEncode(e.type),content:j.highlightTerm(j.htmlEncode(e.name),a)})).attr("data-uid",f);0===g&&G(f);b.showAvatars&&(e.avatar?d(b.templates.autocompleteListItemAvatar({avatar:e.avatar})):d(b.templates.autocompleteListItemIcon({icon:e.icon}))).prependTo(f);
f.appendTo(h)});g.show();h.show()}else s()}):s()}var H,e,I,g,q,w,k,f=[],F={},m=[],n;b=d.extend(!0,{},J,b);return{init:function(a){H=a;e=d(H);"true"!=e.attr("data-mentions-input")&&(I=e.parent(),q=d(b.templates.wrapper()),e.wrapAll(q),q=I.find("> div"),e.attr("data-mentions-input","true"),e.bind("keydown",P),e.bind("keypress",O),e.bind("input",M),e.bind("click",K),e.bind("blur",L),b.elastic&&e.elastic());g=d(b.templates.autocompleteList());g.appendTo(q);g.delegate("li","mousedown",x);w=d(b.templates.mentionsOverlay());
w.prependTo(q);e.val("");f=[];h();b.prefillMention&&p(b.prefillMention)},val:function(a){if(c.isFunction(a)){var b=f.length?e.data("messageText"):r();a.call(this,b)}},reset:function(){e.val("");f=[];h()},getMentions:function(a){c.isFunction(a)&&a.call(this,f)}}};d.fn.mentionsInput=function(b,h){var j=arguments;if("object"===typeof b||!b)h=b;return this.each(function(){var p=d.data(this,"mentionsInput")||d.data(this,"mentionsInput",new x(h));if(c.isFunction(p[b]))return p[b].apply(this,Array.prototype.slice.call(j,
1));if("object"===typeof b||!b)return p.init.call(this,this);d.error("Method "+b+" does not exist")})}})(jQuery,_);